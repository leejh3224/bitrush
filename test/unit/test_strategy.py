import json
from datetime import datetime
from typing import List

from lib.candle.candle import build_feed, Candle
from lib.candle.candle_entity import CandleEntity
from lib.candle.candle_entity_adapter import CandleEntityAdapter
from lib.util import snake_to_camel, get_strategy_by_name, load_strategies


def test_strategy():
    strategies = load_strategies()
    candles = get_candles()

    for (name, module) in strategies:
        Strategy = getattr(module, snake_to_camel(name))
        strategy = Strategy(feed=build_feed(candles))

        assert strategy.get_name() != ""
        assert strategy.is_valid() == True

def get_candles() -> List[Candle]:
    json_array = """[
  {
    "id": 4158,
    "ticker": "BTC",
    "closed_at": "2021-12-12 00:00:00",
    "open": 61414000.00000000,
    "high": 61810000.00000000,
    "low": 61000000.00000000,
    "close": 61293000.00000000,
    "volume": 1227.69302861
  },
  {
    "id": 4162,
    "ticker": "BTC",
    "closed_at": "2021-12-11 00:00:00",
    "open": 59749000.00000000,
    "high": 61538000.00000000,
    "low": 59500000.00000000,
    "close": 61427000.00000000,
    "volume": 3629.53676960
  },
  {
    "id": 4156,
    "ticker": "BTC",
    "closed_at": "2021-12-10 00:00:00",
    "open": 59425000.00000000,
    "high": 61995000.00000000,
    "low": 59106000.00000000,
    "close": 60241000.00000000,
    "volume": 6051.77682154
  },
  {
    "id": 4154,
    "ticker": "BTC",
    "closed_at": "2021-12-09 00:00:00",
    "open": 62217000.00000000,
    "high": 62499000.00000000,
    "low": 60221000.00000000,
    "close": 60577000.00000000,
    "volume": 4790.79921310
  },
  {
    "id": 4152,
    "ticker": "BTC",
    "closed_at": "2021-12-08 00:00:00",
    "open": 63205000.00000000,
    "high": 63450000.00000000,
    "low": 60500000.00000000,
    "close": 62835000.00000000,
    "volume": 5962.10518830
  },
  {
    "id": 4150,
    "ticker": "BTC",
    "closed_at": "2021-12-07 00:00:00",
    "open": 62632000.00000000,
    "high": 64104000.00000000,
    "low": 62316000.00000000,
    "close": 63750000.00000000,
    "volume": 6555.86280836
  },
  {
    "id": 4148,
    "ticker": "BTC",
    "closed_at": "2021-12-06 00:00:00",
    "open": 61877000.00000000,
    "high": 62000000.00000000,
    "low": 59016000.00000000,
    "close": 60372000.00000000,
    "volume": 9059.89675825
  },
  {
    "id": 4146,
    "ticker": "BTC",
    "closed_at": "2021-12-05 00:00:00",
    "open": 62178000.00000000,
    "high": 63297000.00000000,
    "low": 60388000.00000000,
    "close": 60826000.00000000,
    "volume": 9519.00305491
  },
  {
    "id": 4144,
    "ticker": "BTC",
    "closed_at": "2021-12-04 00:00:00",
    "open": 68068000.00000000,
    "high": 68191000.00000000,
    "low": 56000000.00000000,
    "close": 61003000.00000000,
    "volume": 24685.47552420
  },
  {
    "id": 4142,
    "ticker": "BTC",
    "closed_at": "2021-12-03 00:00:00",
    "open": 70563000.00000000,
    "high": 71189000.00000000,
    "low": 70032000.00000000,
    "close": 70180000.00000000,
    "volume": 10243.26630939
  },
  {
    "id": 4140,
    "ticker": "BTC",
    "closed_at": "2021-12-02 00:00:00",
    "open": 70936000.00000000,
    "high": 71500000.00000000,
    "low": 69958000.00000000,
    "close": 70741000.00000000,
    "volume": 6603.08293580
  },
  {
    "id": 4138,
    "ticker": "BTC",
    "closed_at": "2021-12-01 00:00:00",
    "open": 70771000.00000000,
    "high": 72562000.00000000,
    "low": 70500000.00000000,
    "close": 72331000.00000000,
    "volume": 5786.54403532
  },
  {
    "id": 4136,
    "ticker": "BTC",
    "closed_at": "2021-11-30 00:00:00",
    "open": 72241000.00000000,
    "high": 72831000.00000000,
    "low": 70000000.00000000,
    "close": 72782000.00000000,
    "volume": 6027.31653412
  },
  {
    "id": 4128,
    "ticker": "BTC",
    "closed_at": "2021-11-29 00:00:00",
    "open": 72255000.00000000,
    "high": 73158000.00000000,
    "low": 71298000.00000000,
    "close": 71554000.00000000,
    "volume": 4432.59710621
  },
  {
    "id": 4122,
    "ticker": "BTC",
    "closed_at": "2021-11-28 00:00:00",
    "open": 70039000.00000000,
    "high": 70130000.00000000,
    "low": 69133000.00000000,
    "close": 69716000.00000000,
    "volume": 884.62669927
  },
  {
    "id": 4124,
    "ticker": "BTC",
    "closed_at": "2021-11-27 00:00:00",
    "open": 68550000.00000000,
    "high": 70276000.00000000,
    "low": 68140000.00000000,
    "close": 70039000.00000000,
    "volume": 4865.73785339
  },
  {
    "id": 13,
    "ticker": "BTC",
    "closed_at": "2021-11-26 00:00:00",
    "open": 73160000.00000000,
    "high": 73567000.00000000,
    "low": 69402000.00000000,
    "close": 69977000.00000000,
    "volume": 10183.88991779
  },
  {
    "id": 14,
    "ticker": "BTC",
    "closed_at": "2021-11-25 00:00:00",
    "open": 71689000.00000000,
    "high": 73700000.00000000,
    "low": 71220000.00000000,
    "close": 73395000.00000000,
    "volume": 7339.93635739
  },
  {
    "id": 15,
    "ticker": "BTC",
    "closed_at": "2021-11-24 00:00:00",
    "open": 71726000.00000000,
    "high": 71920000.00000000,
    "low": 70265000.00000000,
    "close": 70395000.00000000,
    "volume": 4809.29118104
  },
  {
    "id": 16,
    "ticker": "BTC",
    "closed_at": "2021-11-23 00:00:00",
    "open": 70589000.00000000,
    "high": 71950000.00000000,
    "low": 69556000.00000000,
    "close": 71611000.00000000,
    "volume": 6206.72413827
  },
  {
    "id": 17,
    "ticker": "BTC",
    "closed_at": "2021-11-22 00:00:00",
    "open": 73096000.00000000,
    "high": 73498000.00000000,
    "low": 71047000.00000000,
    "close": 72289000.00000000,
    "volume": 5737.63934832
  },
  {
    "id": 18,
    "ticker": "BTC",
    "closed_at": "2021-11-21 00:00:00",
    "open": 73669000.00000000,
    "high": 73837000.00000000,
    "low": 72695000.00000000,
    "close": 73242000.00000000,
    "volume": 3217.03647507
  },
  {
    "id": 19,
    "ticker": "BTC",
    "closed_at": "2021-11-20 00:00:00",
    "open": 71813000.00000000,
    "high": 73400000.00000000,
    "low": 71608000.00000000,
    "close": 72005000.00000000,
    "volume": 4149.14405704
  },
  {
    "id": 20,
    "ticker": "BTC",
    "closed_at": "2021-11-19 00:00:00",
    "open": 70602000.00000000,
    "high": 72215000.00000000,
    "low": 69150000.00000000,
    "close": 71788000.00000000,
    "volume": 7871.26591304
  },
  {
    "id": 21,
    "ticker": "BTC",
    "closed_at": "2021-11-18 00:00:00",
    "open": 73941000.00000000,
    "high": 74494000.00000000,
    "low": 72490000.00000000,
    "close": 73195000.00000000,
    "volume": 11535.05568955
  },
  {
    "id": 22,
    "ticker": "BTC",
    "closed_at": "2021-11-17 00:00:00",
    "open": 73897000.00000000,
    "high": 74712000.00000000,
    "low": 72000000.00000000,
    "close": 73148000.00000000,
    "volume": 8717.93493845
  },
  {
    "id": 23,
    "ticker": "BTC",
    "closed_at": "2021-11-16 00:00:00",
    "open": 77600000.00000000,
    "high": 77602000.00000000,
    "low": 73325000.00000000,
    "close": 74983000.00000000,
    "volume": 11087.45902535
  },
  {
    "id": 24,
    "ticker": "BTC",
    "closed_at": "2021-11-15 00:00:00",
    "open": 79323000.00000000,
    "high": 80250000.00000000,
    "low": 78220000.00000000,
    "close": 78400000.00000000,
    "volume": 5034.33895922
  },
  {
    "id": 25,
    "ticker": "BTC",
    "closed_at": "2021-11-14 00:00:00",
    "open": 77867000.00000000,
    "high": 78999000.00000000,
    "low": 77820000.00000000,
    "close": 78106000.00000000,
    "volume": 2748.80221102
  },
  {
    "id": 26,
    "ticker": "BTC",
    "closed_at": "2021-11-13 00:00:00",
    "open": 78165000.00000000,
    "high": 78770000.00000000,
    "low": 77120000.00000000,
    "close": 78513000.00000000,
    "volume": 3330.35339270
  },
  {
    "id": 27,
    "ticker": "BTC",
    "closed_at": "2021-11-12 00:00:00",
    "open": 78938000.00000000,
    "high": 79100000.00000000,
    "low": 77265000.00000000,
    "close": 77446000.00000000,
    "volume": 5599.36460554
  },
  {
    "id": 28,
    "ticker": "BTC",
    "closed_at": "2021-11-11 00:00:00",
    "open": 79663000.00000000,
    "high": 79732000.00000000,
    "low": 78543000.00000000,
    "close": 79265000.00000000,
    "volume": 5736.41660112
  },
  {
    "id": 29,
    "ticker": "BTC",
    "closed_at": "2021-11-10 00:00:00",
    "open": 80813000.00000000,
    "high": 82520000.00000000,
    "low": 79313000.00000000,
    "close": 81857000.00000000,
    "volume": 7570.93133957
  },
  {
    "id": 30,
    "ticker": "BTC",
    "closed_at": "2021-11-09 00:00:00",
    "open": 81402000.00000000,
    "high": 82700000.00000000,
    "low": 80237000.00000000,
    "close": 80427000.00000000,
    "volume": 7167.52019281
  },
  {
    "id": 31,
    "ticker": "BTC",
    "closed_at": "2021-11-08 00:00:00",
    "open": 76649000.00000000,
    "high": 80300000.00000000,
    "low": 76534000.00000000,
    "close": 79561000.00000000,
    "volume": 7022.02271089
  },
  {
    "id": 32,
    "ticker": "BTC",
    "closed_at": "2021-11-07 00:00:00",
    "open": 74576000.00000000,
    "high": 75916000.00000000,
    "low": 74481000.00000000,
    "close": 75177000.00000000,
    "volume": 3209.75199409
  },
  {
    "id": 33,
    "ticker": "BTC",
    "closed_at": "2021-11-06 00:00:00",
    "open": 74092000.00000000,
    "high": 74444000.00000000,
    "low": 73800000.00000000,
    "close": 74077000.00000000,
    "volume": 3099.25954397
  },
  {
    "id": 34,
    "ticker": "BTC",
    "closed_at": "2021-11-05 00:00:00",
    "open": 73807000.00000000,
    "high": 75000000.00000000,
    "low": 73490000.00000000,
    "close": 74370000.00000000,
    "volume": 4236.46782464
  },
  {
    "id": 35,
    "ticker": "BTC",
    "closed_at": "2021-11-04 00:00:00",
    "open": 74607000.00000000,
    "high": 74880000.00000000,
    "low": 73480000.00000000,
    "close": 73873000.00000000,
    "volume": 4381.62440450
  },
  {
    "id": 36,
    "ticker": "BTC",
    "closed_at": "2021-11-03 00:00:00",
    "open": 74106000.00000000,
    "high": 74550000.00000000,
    "low": 72734000.00000000,
    "close": 72864000.00000000,
    "volume": 5656.09332882
  },
  {
    "id": 37,
    "ticker": "BTC",
    "closed_at": "2021-11-02 00:00:00",
    "open": 72402000.00000000,
    "high": 75120000.00000000,
    "low": 72031000.00000000,
    "close": 74542000.00000000,
    "volume": 5838.16350080
  },
  {
    "id": 38,
    "ticker": "BTC",
    "closed_at": "2021-11-01 00:00:00",
    "open": 72325000.00000000,
    "high": 73928000.00000000,
    "low": 71003000.00000000,
    "close": 73050000.00000000,
    "volume": 4882.86217703
  },
  {
    "id": 39,
    "ticker": "BTC",
    "closed_at": "2021-10-31 00:00:00",
    "open": 73428000.00000000,
    "high": 74502000.00000000,
    "low": 71869000.00000000,
    "close": 71984000.00000000,
    "volume": 6260.04011648
  },
  {
    "id": 40,
    "ticker": "BTC",
    "closed_at": "2021-10-30 00:00:00",
    "open": 74568000.00000000,
    "high": 74748000.00000000,
    "low": 73000000.00000000,
    "close": 73660000.00000000,
    "volume": 3998.92798528
  },
  {
    "id": 41,
    "ticker": "BTC",
    "closed_at": "2021-10-29 00:00:00",
    "open": 73028000.00000000,
    "high": 74576000.00000000,
    "low": 72676000.00000000,
    "close": 74264000.00000000,
    "volume": 5298.80717156
  },
  {
    "id": 42,
    "ticker": "BTC",
    "closed_at": "2021-10-28 00:00:00",
    "open": 71833000.00000000,
    "high": 74419000.00000000,
    "low": 71028000.00000000,
    "close": 74001000.00000000,
    "volume": 6310.50860884
  },
  {
    "id": 43,
    "ticker": "BTC",
    "closed_at": "2021-10-27 00:00:00",
    "open": 73293000.00000000,
    "high": 74200000.00000000,
    "low": 70180000.00000000,
    "close": 72533000.00000000,
    "volume": 13168.93346824
  },
  {
    "id": 44,
    "ticker": "BTC",
    "closed_at": "2021-10-26 00:00:00",
    "open": 76250000.00000000,
    "high": 76480000.00000000,
    "low": 75001000.00000000,
    "close": 75070000.00000000,
    "volume": 5241.22486682
  },
  {
    "id": 45,
    "ticker": "BTC",
    "closed_at": "2021-10-25 00:00:00",
    "open": 74501000.00000000,
    "high": 77024000.00000000,
    "low": 74210000.00000000,
    "close": 76729000.00000000,
    "volume": 5692.85354883
  },
  {
    "id": 46,
    "ticker": "BTC",
    "closed_at": "2021-10-24 00:00:00",
    "open": 74830000.00000000,
    "high": 75150000.00000000,
    "low": 73700000.00000000,
    "close": 74155000.00000000,
    "volume": 4213.62649570
  }
]"""
    json_array = json.loads(json_array)
    candles = []

    for _json in reversed(json_array):
        candles.append(CandleEntityAdapter(
            CandleEntity(
                ticker=_json.get("ticker"),
                closed_at=datetime.fromisoformat(_json.get("closed_at")),
                open=_json.get("open"),
                high=_json.get("high"),
                low=_json.get("low"),
                close=_json.get("close"),
                volume=_json.get("volume")
            )
        ))

    return candles
